{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 p-4 md:p-6">
    <div class="max-w-4xl mx-auto">
        
        <div class="mb-6">
            <a href="{% url 'sistema_interno:painel_colaborador' %}" class="inline-flex items-center text-red-900 font-black uppercase tracking-tighter hover:scale-105 transition-transform">
                <i class="fas fa-arrow-left mr-2"></i> Voltar ao Painel
            </a>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-gray-100">
            <div class="p-8 bg-gradient-to-r from-red-900 to-red-800 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black uppercase italic tracking-tighter">Novo Agendamento</h1>
                    <p class="text-xs font-bold text-red-200 uppercase tracking-widest mt-1">Pesquise o paciente e defina o atendimento</p>
                </div>
                <div class="bg-white/10 p-4 rounded-2xl">
                    <i class="fas fa-user-clock text-2xl"></i>
                </div>
            </div>

            <form id="form-agenda" class="p-8 space-y-6">
                {% csrf_token %}
                
                <div class="relative">
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2 tracking-widest">Pesquisar Paciente (Nome ou CPF)</label>
                    <div class="relative">
                        <input type="text" id="input_busca" autocomplete="off" placeholder="COMECE A DIGITAR O NOME..." 
                            class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-red-800 transition-all uppercase pl-12">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i>
                    </div>
                    
                    <div id="res_busca" class="absolute z-50 w-full bg-white shadow-2xl rounded-2xl mt-2 hidden border border-gray-100 overflow-hidden">
                        </div>
                    
                    <input type="hidden" name="paciente_nome" id="paciente_nome_hidden">
                </div>

                <div id="badge_plano" class="hidden p-5 rounded-[1.5rem] bg-red-50 border border-red-100 flex flex-wrap justify-between items-center animate-fade-in">
                    <div class="flex items-center">
                        <div class="bg-red-800 p-3 rounded-xl mr-4 text-white">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <div>
                            <span class="text-[10px] font-black text-red-400 uppercase block tracking-widest">Convênio Atual</span>
                            <span id="txt_plano" class="font-black text-red-900 uppercase text-lg">---</span>
                        </div>
                    </div>
                    <div class="text-right border-l border-red-100 pl-6">
                        <span class="text-[10px] font-black text-red-400 uppercase block tracking-widest">CPF Registrado</span>
                        <span id="txt_cpf" class="font-bold text-gray-700">---</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Médico / Especialista</label>
                        <input type="text" name="medico" required placeholder="NOME DO PROFISSIONAL" 
                            class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-red-800 uppercase">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Valor de Tabela (R$)</label>
                        <input type="number" name="valor" step="0.01" required placeholder="0.00" 
                            class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold text-green-700 focus:ring-2 focus:ring-red-800">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Procedimento</label>
                        <select name="tipo" id="tipo_select" onchange="toggleExames()" 
                            class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-red-800">
                            <option value="CONSULTA">CONSULTA MÉDICA</option>
                            <option value="EXAME">REALIZAÇÃO DE EXAME</option>
                        </select>
                    </div>
                    <div id="div_exames" class="hidden animate-fade-in">
                        <label class="block text-[10px] font-black uppercase text-red-800 mb-2 ml-2">Qual o Exame?</label>
                        <select name="exame_nome" class="w-full bg-red-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-red-800">
                            <option value="">-- SELECIONE O EXAME --</option>
                            <optgroup label="ULTRASSONOGRAFIA">
                                <option value="USG ABDOMEN TOTAL">USG ABDOMEN TOTAL</option>
                                <option value="USG TRANSVAGINAL">USG TRANSVAGINAL</option>
                                <option value="USG MAMAS">USG MAMAS</option>
                                <option value="USG TIREOIDE">USG TIREOIDE</option>
                            </optgroup>
                            <optgroup label="CARDIOLOGIA">
                                <option value="ECG">ELETROCARDIOGRAMA</option>
                                <option value="ECOCARDIOGRAMA">ECOCARDIOGRAMA</option>
                            </optgroup>
                            <optgroup label="OUTROS">
                                <option value="RAIO-X">RAIO-X GERAL</option>
                                <option value="MAMOGRAFIA">MAMOGRAFIA</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Data</label>
                        <input type="date" name="data" required class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-red-800">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Hora</label>
                        <input type="time" name="hora" required class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-red-800">
                    </div>
                </div>

                <button type="submit" id="btn-submit" class="w-full bg-red-900 text-white p-5 rounded-[1.5rem] font-black uppercase tracking-widest hover:bg-red-800 transition-all shadow-xl shadow-red-900/20 active:scale-95">
                    Confirmar Agendamento e Gerar Fatura
                </button>
            </form>
        </div>
    </div>
</div>

<script>
const inputBusca = document.getElementById('input_busca');
const resBusca = document.getElementById('res_busca');

// Função de Busca Dinâmica
inputBusca.oninput = async () => {
    const termo = inputBusca.value;
    if(termo.length < 3) { 
        resBusca.classList.add('hidden'); 
        return; 
    }
    
    const r = await fetch(`/sistema/api/buscar-paciente/?term=${termo}`);
    const d = await r.json();
    
    if(d.results.length > 0) {
        resBusca.innerHTML = d.results.map(p => `
            <div onclick="selecionar('${p.nome}', '${p.cpf}', '${p.convenio}')" 
                class="p-4 hover:bg-red-50 cursor-pointer border-b border-gray-50 transition-colors">
                <div class="font-black text-xs uppercase text-red-900">${p.nome}</div>
                <div class="text-[10px] text-gray-500 font-bold uppercase tracking-tighter">
                    CPF: ${p.cpf} | <span class="bg-red-100 text-red-800 px-2 rounded-full">${p.convenio}</span>
                </div>
            </div>
        `).join('');
        resBusca.classList.remove('hidden');
    } else {
        resBusca.classList.add('hidden');
    }
};

// Ao selecionar o paciente da lista
function selecionar(nome, cpf, convenio) {
    document.getElementById('paciente_nome_hidden').value = nome;
    inputBusca.value = nome;
    document.getElementById('txt_plano').innerText = convenio;
    document.getElementById('txt_cpf').innerText = cpf;
    document.getElementById('badge_plano').classList.remove('hidden');
    resBusca.classList.add('hidden');
}

// Alternar campo de exames
function toggleExames() {
    const tipo = document.getElementById('tipo_select').value;
    const div = document.getElementById('div_exames');
    div.classList.toggle('hidden', tipo !== 'EXAME');
}

// Envio do formulário
document.getElementById('form-agenda').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-submit');
    
    if(!document.getElementById('paciente_nome_hidden').value) {
        alert('Por favor, selecione um paciente da lista de pesquisa!');
        return;
    }

    btn.disabled = true;
    btn.innerText = "CALCULANDO REGRAS...";

    const formData = new FormData(e.target);
    try {
        const response = await fetch('', { method: 'POST', body: formData });
        const data = await response.json();
        if (data.success) {
            alert('✅ SUCESSO!\nAgendamento confirmado.\nValor Final Aplicado: R$ ' + data.valor_final.toFixed(2));
            window.location.reload();
        } else {
            alert('❌ Erro: ' + data.error);
            btn.disabled = false;
            btn.innerText = "CONFIRMAR AGENDAMENTO";
        }
    } catch (err) {
        alert('❌ Erro de conexão com o servidor.');
        btn.disabled = false;
    }
};
</script>
{% endblock %}
