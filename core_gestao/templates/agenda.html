{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 p-4 md:p-6">
    <div class="max-w-4xl mx-auto">

        <div class="mb-6">
            <a href="{% url 'sistema_interno:painel_colaborador' %}" class="inline-flex items-center text-marsala-800 font-black uppercase tracking-tighter hover:scale-105 transition-transform no-underline">
                <i class="fas fa-arrow-left mr-2"></i> Voltar ao Painel
            </a>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-gray-100">
            <div class="p-8 bg-gradient-to-r from-marsala-800 to-marsala-700 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black uppercase italic tracking-tighter">Novo Agendamento</h1>
                    <p class="text-xs font-bold text-marsala-100 uppercase tracking-widest mt-1">Defina o procedimento e valide o pagamento</p>
                </div>
                <div class="bg-white/10 p-4 rounded-2xl">
                    <i class="fas fa-cash-register text-2xl"></i>
                </div>
            </div>

            <form id="form-agenda" class="p-8 space-y-6">
                {% csrf_token %}

                <div class="relative">
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2 tracking-widest">1. Pesquisar Paciente</label>
                    <div class="relative">
                        <input type="text" id="input_busca" autocomplete="off" placeholder="DIGITE NOME OU CPF..."
                            class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-marsala-700 transition-all uppercase pl-12">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i>
                    </div>
                    <div id="res_busca" class="absolute z-50 w-full bg-white shadow-2xl rounded-2xl mt-2 hidden border border-gray-100 overflow-hidden"></div>
                    <input type="hidden" name="paciente_id" id="paciente_id_hidden">
                </div>

                <div id="badge_plano" class="hidden p-5 rounded-[1.5rem] bg-marsala-50 border border-marsala-100 flex flex-wrap justify-between items-center animate-fade-in">
                    <div class="flex items-center">
                        <div class="bg-marsala-800 p-3 rounded-xl mr-4 text-white"><i class="fas fa-id-card"></i></div>
                        <div>
                            <span class="text-[10px] font-black text-marsala-400 uppercase block tracking-widest">Plano Identificado</span>
                            <span id="txt_plano" class="font-black text-marsala-900 uppercase text-lg">---</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] font-black text-marsala-400 uppercase block tracking-widest">CPF</span>
                        <span id="txt_cpf" class="font-bold text-gray-700 uppercase">---</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">2. Procedimento</label>
                        <select name="tipo" id="tipo_select" onchange="toggleExameCampo()" class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-marsala-700">
                            <option value="CONSULTA">CONSULTA MÉDICA</option>
                            <option value="EXAME">REALIZAÇÃO DE EXAME</option>
                        </select>
                    </div>
                    <div id="div_exame_especifico" class="hidden">
                        <label class="block text-[10px] font-black uppercase text-marsala-700 mb-2 ml-2">Qual o Exame?</label>
                        <input type="text" name="exame_nome" placeholder="EX: USG ABDOMEN" class="w-full bg-marsala-50 border-none rounded-2xl p-4 text-sm font-bold uppercase focus:ring-2 focus:ring-marsala-700">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">3. Nº Comprovante / Ref. Pagamento</label>
                    <input type="text" name="comprovante" required placeholder="EX: PIX DATA/HORA OU COD. AUTENTICAÇÃO" class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold uppercase focus:ring-2 focus:ring-marsala-700">
                </div>

                <div class="bg-gray-100 p-6 rounded-[2.5rem] mt-6 grid grid-cols-1 md:grid-cols-2 gap-8 items-center border border-dashed border-gray-300">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2 italic">Valor de Tabela (R$)</label>
                        <input type="number" name="valor_cheio" id="valor_tabela" step="0.01" oninput="recalcularDesconto()" placeholder="0.00"
                            class="w-full bg-white border-none rounded-2xl p-4 text-2xl font-black text-gray-800 focus:ring-2 focus:ring-marsala-700">
                    </div>
                    <div class="text-right pr-4">
                        <p class="text-[10px] font-black uppercase text-marsala-400 tracking-widest leading-none mb-2">Valor com Desconto</p>
                        <h3 class="text-4xl font-black text-marsala-700 leading-none">R$ <span id="span_valor_desconto">0.00</span></h3>
                        <p id="label_plano_ativo" class="text-[9px] font-black text-emerald-600 uppercase mt-2 italic"></p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Data</label>
                        <input type="date" name="data" required value="{% now 'Y-m-d' %}" class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Hora</label>
                        <input type="time" name="hora" required class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold">
                    </div>
                </div>

                <button type="submit" id="btn-submit" class="w-full bg-marsala-800 text-white p-6 rounded-[2rem] font-black uppercase tracking-widest hover:bg-marsala-700 transition-all shadow-xl shadow-marsala-900/20 border-none cursor-pointer">
                    Confirmar e Gerar Fatura Paga
                </button>
            </form>
        </div>
    </div>
</div>

<script>
const inputBusca = document.getElementById('input_busca');
const resBusca = document.getElementById('res_busca');

inputBusca.oninput = async () => {
    const termo = inputBusca.value;
    if(termo.length < 3) { resBusca.classList.add('hidden'); return; }

    const r = await fetch(`/sistema/api/buscar-paciente/?q=${termo}`);
    const d = await r.json();

    if(d.results.length > 0) {
        resBusca.innerHTML = d.results.map(p => {
            const partes = p.text.split(' (');
            const nome = partes[0];
            const cpf = partes[1].replace(')', '');
            return `
                <div onclick="selecionar('${p.id}', '${nome}', '${cpf}')" class="p-4 hover:bg-marsala-50 cursor-pointer border-b border-gray-50 transition-colors">
                    <div class="font-black text-xs uppercase text-marsala-900">${nome}</div>
                    <div class="text-[10px] text-gray-500 font-bold uppercase tracking-tighter">CPF: ${cpf}</div>
                </div>
            `;
        }).join('');
        resBusca.classList.remove('hidden');
    }
};

function selecionar(id, nome, cpf) {
    document.getElementById('paciente_id_hidden').value = id;
    inputBusca.value = nome;
    document.getElementById('txt_cpf').innerText = cpf;
    document.getElementById('badge_plano').classList.remove('hidden');
    resBusca.classList.add('hidden');
    
    // Simulação rápida para feedback na tela (o views.py fará o cálculo oficial)
    document.getElementById('txt_plano').innerText = "CALCULANDO...";
    
    // Aqui você pode adicionar um fetch para pegar o nome do plano se quiser 100% de precisão na tela,
    // mas o views.py já faz isso ao salvar. Para teste, assumimos Master:
    document.getElementById('txt_plano').innerText = "ULTRAMED MASTER"; 
    recalcularDesconto();
}

function toggleExameCampo() {
    const tipo = document.getElementById('tipo_select').value;
    document.getElementById('div_exame_especifico').classList.toggle('hidden', tipo !== 'EXAME');
}

function recalcularDesconto() {
    const valorCheio = parseFloat(document.getElementById('valor_tabela').value) || 0;
    const plano = document.getElementById('txt_plano').innerText.toUpperCase();
    let percentual = 0;

    if (plano.includes('ESSENCIAL')) percentual = 0.30;
    else if (plano.includes('MASTER')) percentual = 0.30;
    else if (plano.includes('EMPRESARIAL')) percentual = 0.35;

    const valorFinal = valorCheio * (1 - percentual);
    document.getElementById('span_valor_desconto').innerText = valorFinal.toFixed(2);
    document.getElementById('label_plano_ativo').innerText = percentual > 0 ? `PLANO ATIVO: ${(percentual*100)}% OFF` : "SEM PLANO ATIVO";
}

document.getElementById('form-agenda').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-submit');

    if(!document.getElementById('paciente_id_hidden').value) {
        alert('Selecione um paciente na lista!');
        return;
    }

    btn.disabled = true;
    btn.innerText = "PROCESSANDO...";

    const formData = new FormData(e.target);
    try {
        const response = await fetch('', { method: 'POST', body: formData });
        if (response.ok) {
            alert('✅ Agendamento e Fatura realizados com sucesso!');
            window.location.href = "{% url 'sistema_interno:painel_colaborador' %}";
        } else {
            alert('❌ Erro ao salvar agendamento.');
            btn.disabled = false;
            btn.innerText = "TENTAR NOVAMENTE";
        }
    } catch (err) {
        alert('❌ Erro de conexão.');
        btn.disabled = false;
    }
};
</script>
{% endblock %}
