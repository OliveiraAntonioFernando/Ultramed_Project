{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="bg-gray-100 min-h-screen pb-20 font-sans text-left">
    <nav class="bg-gradient-to-r from-marsala-800 to-marsala-700 p-8 rounded-b-[3.5rem] shadow-2xl text-white mb-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h2 class="text-3xl font-black italic uppercase tracking-tighter text-white">Gest√£o Ultramed</h2>
            <div class="flex gap-4">
                <button onclick="abrirModal()" class="bg-white text-marsala-800 px-8 py-4 rounded-2xl font-black uppercase italic text-xs shadow-lg hover:scale-105 transition-all flex items-center gap-3 border-none cursor-pointer">
                    <i class="fas fa-user-plus"></i> Novo Registro
                </button>
                <a href="{% url 'sistema_interno:painel_colaborador' %}" class="bg-white/10 px-6 py-4 rounded-2xl hover:bg-white/20 transition-all text-xs font-bold uppercase italic flex items-center border border-white/10 text-white no-underline">Voltar</a>
            </div>
        </div>
    </nav>

    <main class="max-w-[95%] mx-auto">
        <div class="bg-white rounded-[3rem] shadow-xl border border-gray-100 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50/50">
                        <th class="p-8 text-[11px] font-black uppercase text-gray-400">Paciente / Tipo</th>
                        <th class="p-8 text-[11px] font-black uppercase text-gray-400 text-center">CPF</th>
                        <th class="p-8 text-[11px] font-black uppercase text-gray-400 text-center">Plano Ativo</th>
                        <th class="p-8 text-[11px] font-black uppercase text-gray-400 text-center">Vencimento</th>
                        <th class="p-8 text-[11px] font-black uppercase text-gray-400 text-right">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for p in pacientes %}
                    <tr class="hover:bg-gray-50/80 transition-all">
                        <td class="p-8">
                            <p class="text-sm font-black uppercase text-gray-800 italic">{{ p.nome_completo }}</p>
                            {% if p.responsavel %}
                                <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-black uppercase italic border border-blue-200">Dependente</span>
                            {% else %}
                                <span class="text-[9px] bg-green-100 text-green-600 px-2 py-0.5 rounded font-black uppercase italic border border-green-200">Titular</span>
                            {% endif %}
                        </td>
                        <td class="p-8 text-center text-xs font-mono font-bold text-gray-500">{{ p.cpf|default:"---" }}</td>
                        <td class="p-8 text-center">
                            {% if p.plano %}
                                {% if "MASTER" in p.plano.nome|upper %}
                                    <span class="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-2xl text-[10px] font-black uppercase italic border border-yellow-300 shadow-sm">‚≠ê {{ p.plano.nome }}</span>
                                {% elif "ESSENCIAL" in p.plano.nome|upper %}
                                    <span class="bg-blue-100 text-blue-700 px-4 py-2 rounded-2xl text-[10px] font-black uppercase italic border border-blue-300 shadow-sm">üîπ {{ p.plano.nome }}</span>
                                {% else %}
                                    <span class="bg-marsala-50 text-marsala-700 px-4 py-2 rounded-2xl text-[10px] font-black uppercase italic border border-marsala-200 shadow-sm">{{ p.plano.nome }}</span>
                                {% endif %}
                            {% else %}
                                <span class="bg-gray-100 text-gray-400 px-4 py-2 rounded-2xl text-[10px] font-black uppercase italic border border-gray-200">Particular</span>
                            {% endif %}
                        </td>
                        <td class="p-8 text-center">
                            {% if p.vencimento_plano %}
                                <p class="text-[11px] font-mono font-black text-gray-700 uppercase">
                                    <i class="far fa-calendar-alt mr-1 text-marsala-600"></i> {{ p.vencimento_plano|date:"d/m/Y" }}
                                </p>
                            {% else %}
                                <span class="text-[10px] text-gray-300 font-bold uppercase italic">Sem car√™ncia</span>
                            {% endif %}
                        </td>
                        <td class="p-8 text-right font-black uppercase italic no-underline flex justify-end gap-2 items-center">
                             <button type="button" onclick="abrirModalUpload('{{ p.id }}', '{{ p.nome_completo|escapejs }}')" class="bg-sky-50 text-sky-600 px-4 py-2.5 rounded-xl text-[9px] font-black uppercase italic border-none cursor-pointer hover:bg-sky-100 transition-all">
                                <i class="fas fa-paperclip mr-1"></i> Anexar Exame
                             </button>

                             {% if user.username != 'recepcao' %}
                                <a href="{% url 'sistema_interno:prontuario_view' p.id %}" class="bg-marsala-700 text-white px-6 py-2.5 rounded-xl text-[10px] font-black uppercase italic no-underline shadow-md">Prontu√°rio</a>
                             {% else %}
                                <button disabled class="bg-gray-200 text-gray-400 px-6 py-2.5 rounded-xl text-[10px] font-black uppercase italic border-none cursor-not-allowed">Restrito</button>
                             {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
</div>

<div id="modalPaciente" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[998] hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-5xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
        <div class="bg-marsala-700 p-8 text-white flex justify-between items-center" style="background-color: #700c15;">
            <h3 class="text-2xl font-black uppercase italic tracking-tighter text-white">Admiss√£o Completa</h3>
            <button onclick="fecharModal()" class="text-white border-none bg-transparent cursor-pointer text-2xl">√ó</button>
        </div>
        <form id="formCadastro" method="POST" action="{% url 'sistema_interno:cliente_create' %}" class="p-10 space-y-6 overflow-y-auto text-left">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">Nome Completo</label>
                    <input type="text" id="input_nome" name="nome_completo" required class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-bold uppercase text-xs outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">CPF</label>
                    <input type="text" id="input_cpf" name="cpf" required class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-mono font-bold text-xs outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">WhatsApp</label>
                    <input type="text" id="input_tel" name="telefone" required class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-bold text-xs outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">Nascimento</label>
                    <input type="date" id="input_nasc" name="data_nascimento" required class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-bold text-xs outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">Plano</label>
                    <select name="plano" id="input_plano" class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-bold text-xs outline-none">
                        <option value="">Particular</option>
                        {% for pl in planos %}
                        <option value="{{ pl.id }}">{{ pl.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">Endere√ßo (Rua e N¬∫)</label>
                    <input type="text" id="input_end" name="endereco" class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-bold text-xs outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">Bairro</label>
                    <input type="text" id="input_bairro" name="bairro" class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-bold text-xs outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-marsala-700 block mb-1">Cidade</label>
                    <input type="text" id="input_cidade" name="cidade" value="S√£o F√©lix do Xingu" class="w-full border-2 border-gray-100 bg-gray-50 p-3 rounded-xl font-bold text-xs outline-none">
                </div>
            </div>

            <div class="border-t pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xs font-black uppercase text-marsala-700 italic">Dependentes</h4>
                    <button type="button" onclick="addDep()" class="bg-gray-100 px-4 py-2 rounded-lg text-[9px] font-black uppercase border-none cursor-pointer">+ Adicionar</button>
                </div>
                <div id="container-deps" class="space-y-3"></div>
            </div>

            <button type="button" onclick="abrirContrato()" class="w-full bg-marsala-700 text-white font-black py-5 rounded-[2rem] uppercase italic text-lg shadow-xl border-none cursor-pointer">
                GERAR TERMO DE ADES√ÉO
            </button>
        </form>
    </div>
</div>

<div id="modalUpload" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden">
        <div class="bg-sky-600 p-6 text-white text-center">
            <i class="fas fa-file-medical text-3xl mb-2 opacity-50"></i>
            <h3 class="text-sm font-black uppercase tracking-widest m-0 italic">Anexar Documento</h3>
            <p id="uploadNomePaciente" class="text-[9px] uppercase font-bold mt-1 opacity-80"></p>
        </div>
        
        <form action="{% url 'sistema_interno:upload_exame' %}" method="POST" enctype="multipart/form-data" class="p-8 space-y-5 text-left">
            {% csrf_token %}
            <input type="hidden" name="paciente_id" id="uploadIdPaciente">
            
            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 block mb-1 ml-2">T√≠tulo do Exame</label>
                <input type="text" name="nome_exame" required class="w-full bg-gray-50 border-2 border-gray-100 rounded-xl p-4 text-xs font-bold outline-none" placeholder="Ex: Ultrassonografia, Sangue...">
            </div>
            
            <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center">
                <label class="cursor-pointer">
                    <i class="fas fa-cloud-upload-alt text-2xl text-sky-400 mb-2"></i>
                    <span class="block text-[10px] font-black text-gray-500 uppercase">PDF ou Imagem</span>
                    <input type="file" name="arquivo_exame" required class="hidden" onchange="document.getElementById('fileName').innerText = this.files[0].name">
                    <p id="fileName" class="text-[9px] text-emerald-600 font-bold mt-2 italic"></p>
                </label>
            </div>

            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 bg-marsala-700 text-white font-black py-4 rounded-xl uppercase text-[10px] border-none cursor-pointer">Enviar Anexo</button>
                <button type="button" onclick="fecharModalUpload()" class="flex-1 bg-gray-100 text-gray-400 font-black py-4 rounded-xl uppercase text-[10px] border-none cursor-pointer">Sair</button>
            </div>
        </form>
    </div>
</div>

<div id="modalContrato" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[999] hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-4xl rounded-[2rem] shadow-2xl flex flex-col max-h-[95vh]">
        <div id="printArea" class="p-10 md:p-16 overflow-y-auto text-gray-800 text-[11px] text-justify font-sans leading-relaxed">
            <h1 class="text-center text-lg font-black uppercase mb-1">TERMO DE ADES√ÉO AO PLANO DE ASSINATURA EM SA√öDE</h1>
            <p class="text-center font-bold mb-8">(PROGRAMA DE DESCONTOS)</p>

            <div class="space-y-4">
                <p><strong>CONTRATADA:</strong><br>ULTRAMED CL√çNICA M√âDICA, CNPJ n¬∫ 00.000.000/0000-00, com sede √† Rua [endere√ßo], doravante denominada CL√çNICA.</p>
                <p><strong>ASSINANTE:</strong><br><span id="c_nome" class="font-bold border-b border-black uppercase"></span>, CPF n¬∫ <span id="c_cpf" class="font-bold border-b border-black"></span>, residente em <span id="c_end" class="font-bold border-b border-black uppercase"></span>, Bairro <span id="c_bairro" class="font-bold border-b border-black uppercase"></span>, <span id="c_cidade" class="font-bold border-b border-black uppercase"></span>, doravante denominado ASSINANTE.</p>

                <p><strong>CL√ÅUSULA 1 ‚Äì DO OBJETO</strong><br>1.1. O presente Termo tem por objeto a ades√£o ao PLANO DE ASSINATURA EM SA√öDE <span id="c_plano_termo" class="font-black text-marsala-700"></span>.</p>
                
                <p><strong>DEPENDENTES VINCULADOS:</strong></p>
                <ul id="c_deps" class="list-none p-0 ml-4 font-bold uppercase">
                    </ul>
            </div>

            <div class="mt-20 grid grid-cols-2 gap-12 text-center">
                <div><div class="border-t border-black pt-2"><p class="font-black uppercase" id="s_nome"></p><p>CPF: <span id="s_cpf"></span></p></div></div>
                <div><div class="border-t border-black pt-2"><p class="font-black uppercase">ULTRAMED CL√çNICA M√âDICA</p><p>CONTRATADA</p></div></div>
            </div>
        </div>
        <div class="p-6 bg-gray-50 flex gap-4 border-t">
            <button onclick="confirmarVenda()" class="flex-1 bg-green-600 text-white font-black py-4 rounded-xl uppercase border-none cursor-pointer">Confirmar e Salvar</button>
            <button onclick="fecharContrato()" class="bg-gray-300 text-gray-700 px-8 py-4 rounded-xl font-black uppercase border-none cursor-pointer">Corrigir Dados</button>
        </div>
    </div>
</div>

<script>
    function abrirModal() { document.getElementById('modalPaciente').classList.remove('hidden'); document.getElementById('modalPaciente').classList.add('flex'); }
    function fecharModal() { document.getElementById('modalPaciente').classList.add('hidden'); document.getElementById('modalPaciente').classList.remove('flex'); }

    function abrirModalUpload(id, nome) {
        document.getElementById('uploadIdPaciente').value = id;
        document.getElementById('uploadNomePaciente').innerText = "Anexar para: " + nome;
        document.getElementById('modalUpload').classList.remove('hidden');
        document.getElementById('modalUpload').classList.add('flex');
    }
    function fecharModalUpload() { document.getElementById('modalUpload').classList.add('hidden'); document.getElementById('modalUpload').classList.remove('flex'); }

    function addDep() {
        const container = document.getElementById('container-deps');
        const div = document.createElement('div');
        div.className = "flex gap-2 bg-gray-50 p-3 rounded-xl items-end border border-gray-200 text-left";
        div.innerHTML = `
            <div class="flex-1 text-left"><label class="text-[8px] font-black uppercase text-gray-400 block ml-2">Nome</label><input type="text" name="dep_nome[]" required class="w-full p-2 rounded-lg border-2 border-white font-bold text-xs uppercase d-nome"></div>
            <div class="w-32 text-left"><label class="text-[8px] font-black uppercase text-gray-400 block ml-2">CPF</label><input type="text" name="dep_cpf[]" class="w-full p-2 rounded-lg border-2 border-white font-bold text-xs d-cpf"></div>
            <div class="w-32 text-left"><label class="text-[8px] font-black uppercase text-gray-400 block ml-2">Nascimento</label><input type="date" name="dep_nascimento[]" required class="w-full p-2 rounded-lg border-2 border-white text-xs d-nasc"></div>
            <div class="w-32 text-left">
                <label class="text-[8px] font-black uppercase text-gray-400 block ml-2">Grau</label>
                <select name="dep_parentesco[]" class="w-full p-2 rounded-lg border-2 border-white text-[10px] font-black d-grau">
                    <option value="FILHO(A)">FILHO(A)</option><option value="CONJUGE">CONJUGE</option><option value="PAI/MAE">PAI/MAE</option><option value="ENTEADO(A)">ENTEADO(A)</option>
                </select>
            </div>
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 border-none bg-transparent cursor-pointer p-2"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(div);
    }

    function abrirContrato() {
        document.getElementById('c_nome').innerText = document.getElementById('s_nome').innerText = document.getElementById('input_nome').value;
        document.getElementById('c_cpf').innerText = document.getElementById('s_cpf').innerText = document.getElementById('input_cpf').value;
        document.getElementById('c_end').innerText = document.getElementById('input_end').value;
        document.getElementById('c_bairro').innerText = document.getElementById('input_bairro').value;
        document.getElementById('c_cidade').innerText = document.getElementById('input_cidade').value;

        const sel = document.getElementById('input_plano');
        document.getElementById('c_plano_termo').innerText = sel.options[sel.selectedIndex].text;

        const lista = document.getElementById('c_deps');
        lista.innerHTML = "";
        document.querySelectorAll('#container-deps > div').forEach(row => {
            const nome = row.querySelector('.d-nome').value;
            const grau = row.querySelector('.d-grau').value;
            const cpf = row.querySelector('.d-cpf').value;
            if(nome) lista.innerHTML += `<li>‚Ä¢ ${nome} - CPF: ${cpf} (${grau})</li>`;
        });

        document.getElementById('modalContrato').classList.remove('hidden');
        document.getElementById('modalContrato').classList.add('flex');
    }

    function fecharContrato() { document.getElementById('modalContrato').classList.add('hidden'); }
    function confirmarVenda() { document.getElementById('formCadastro').submit(); }
</script>
{% endblock %}