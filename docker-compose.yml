services:
  db:
    image: mariadb:10.5
    container_name: ultramed-db
    restart: always
    environment:
      - MARIADB_DATABASE=${SQL_DATABASE}
      - MARIADB_USER=${SQL_USER}
      - MARIADB_PASSWORD=${SQL_PASSWORD}
      - MARIADB_ROOT_PASSWORD=${SQL_ROOT_PASSWORD}
    volumes:
      - ultramed_mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${SQL_USER}", "-p${SQL_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    build: .
    container_name: ultramed-web
    restart: always
    command: >
      sh -c "sleep 5 &&
             python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             gunicorn ultramed_app.wsgi:application --bind 0.0.0.0:8000 --workers 3"
    environment:
      - DJANGO_SETTINGS_MODULE=ultramed_app.settings
      - PYTHONPATH=/app
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DEBUG=${DEBUG}
      - SQL_ENGINE=${SQL_ENGINE}
      - SQL_DATABASE=${SQL_DATABASE}
      - SQL_USER=${SQL_USER}
      - SQL_PASSWORD=${SQL_PASSWORD}
      - SQL_HOST=db
      - SQL_PORT=${SQL_PORT}
    volumes:
      - .:/app
      - ./static_content:/app/static_content
      - ./media_content:/app/media_content
    depends_on:
      db:
        condition: service_healthy

  nginx:
    image: nginx:1.24-alpine
    container_name: ultramed-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./static_content:/usr/share/nginx/html/static:ro
      - ./media_content:/usr/share/nginx/html/media:ro
      - ./nginx/certs:/etc/nginx/ssl:ro
    depends_on:
      - web

volumes:
  ultramed_mariadb_data:
